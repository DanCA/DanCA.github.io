<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dibujo con Brython</title>

    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/brython@3.12.0/brython_stdlib.js"></script>

    <style>
        body {
            background: #111;
            color: white;
            text-align: center;
            font-family: Arial;
            margin-top: 20px;
        }

        #controls {
            margin-bottom: 15px;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            background: #2c2c2c;
            color: white;
        }

        button:hover {
            background: #444;
        }

        canvas {
            background: #000;
            border: 1px solid #333;
        }
    </style>
</head>

<body onload="brython()">

    <h1>DIBUJOS CON PYTHON + BRYTHON</h1>

    <div id="controls">
        <button id="btnTulipanes">Dibujar Tulipanes</button>
        <button id="btnRosas">Dibujar Rosas</button>
    </div>

    <div id="status">Listo</div>

    <canvas id="canvas" width="800" height="800"></canvas>

    <script type="text/python">

from browser import document, ajax, window
import json

# === CANVAS Y CONTEXTO =====================================================
canvas = document["canvas"]
ctx = canvas.getContext("2d")

canvas_width = canvas.width
canvas_height = canvas.height

# Estado de "turtle"
turtle_x = canvas_width // 2
turtle_y = canvas_height // 2
turtle_pen_down = True
turtle_data = None
current_shape = 0
drawing = False
scale_factor = 1.0


# === FUNCIONES DE TURTLE PERSONALIZADO ====================================

def pen_up():
    global turtle_pen_down
    turtle_pen_down = False

def pen_down():
    global turtle_pen_down
    turtle_pen_down = True

def set_color(r, g, b):
    ctx.strokeStyle = f"rgb({int(r)}, {int(g)}, {int(b)})"
    ctx.fillStyle = f"rgb({int(r)}, {int(g)}, {int(b)})"

def begin_fill():
    ctx.beginPath()

def end_fill():
    ctx.fill()
    ctx.stroke()

def goto(x, y):
    global turtle_x, turtle_y

    if turtle_pen_down:
        ctx.lineTo(x, y)
        ctx.stroke()
    else:
        ctx.moveTo(x, y)

    turtle_x = x
    turtle_y = y


# === ESTA FUNCIÓN SOLO ESCALA (CASO ROSAS) =================================

def goto_scaled(x, y):
    global turtle_x, turtle_y
    
    if turtle_pen_down:
        ctx.lineTo(x, y)
        ctx.stroke()
    else:
        ctx.moveTo(x, y)

    turtle_x = x
    turtle_y = y


# === DIBUJAR TULIPANES (TU FUNCIÓN ORIGINAL) ==============================

def draw_tulipanes():
    global turtle_data, current_shape, drawing

    ctx.clearRect(0, 0, canvas.width, canvas.height)
    current_shape = 0
    drawing = True

    load_json("./assets/data.json", draw_tulipanes_from_data)

def draw_tulipanes_from_data():
    global turtle_data, current_shape, drawing

    shapes = turtle_data["coordenadas"]
    colors = turtle_data["color"]

    if current_shape >= len(shapes):
        drawing = False
        document["status"].textContent = "Dibujo de tulipanes completado"
        return

    shape = shapes[current_shape]
    color = colors[current_shape]

    r = int(color[0] * 255)
    g = int(color[1] * 255)
    b = int(color[2] * 255)

    set_color(r, g, b)
    begin_fill()

    # Primer punto
    pen_up()
    x = shape[0][0] * scale_factor + canvas_width/2
    y = canvas_height/2 - shape[0][1] * scale_factor
    goto(x, y)
    pen_down()

    # Resto de puntos
    for px, py in shape:
        sx = px * scale_factor + canvas_width/2
        sy = canvas_height/2 - py * scale_factor
        goto(sx, sy)

    end_fill()

    current_shape += 1

    window.setTimeout(draw_tulipanes_from_data, 50)


# === DIBUJAR ROSAS (ADAPTACIÓN DEL TURTLE NORMAL) ==========================

def draw_rosas():
    ctx.clearRect(0, 0, canvas.width, canvas.height)
    load_json("./assets/rosas.json", draw_rosas_from_data)

def draw_rosas_from_data():
    global turtle_data

    regions = turtle_data

    # Extraer todos los puntos
    all_points = [(p[0], p[1]) for r in regions for p in r["contour"]]

    min_x = min(p[0] for p in all_points)
    max_x = max(p[0] for p in all_points)
    min_y = min(p[1] for p in all_points)
    max_y = max(p[1] for p in all_points)

    width = max_x - min_x
    height = max_y - min_y

    desired = min(canvas_width * 0.7, canvas_height * 0.7)
    scale = min(desired / width, desired / height)

    center_x = (min_x + max_x) / 2
    center_y = (min_y + max_y) / 2

    for region in regions:
        r, g, b = region["color"]
        set_color(r, g, b)

        points = region["contour"]
        
        begin_fill()
        pen_up()

        # Primer punto
        x0 = (points[0][0] - center_x) * scale + canvas_width/2
        y0 = (center_y - points[0][1]) * scale + canvas_height/2
        goto_scaled(x0, y0)

        pen_down()

        # Resto
        for px, py in points:
            sx = (px - center_x) * scale + canvas_width/2
            sy = (center_y - py) * scale + canvas_height/2
            goto_scaled(sx, sy)

        end_fill()

    document["status"].textContent = "Dibujo de rosas completado"


# === CARGA GENERAL DE JSON =================================================

def load_json(path, callback):

    def on_complete(req):
        global turtle_data
        if req.status in (0, 200):
            turtle_data = json.loads(req.text)
            callback()
        else:
            document["status"].textContent = f"Error cargando {path}"

    req = ajax.ajax()
    req.bind("complete", on_complete)
    req.open("GET", path, True)
    req.send()


# === EVENTOS DE BOTONES ====================================================

document["btnTulipanes"].bind("click", lambda e: draw_tulipanes())
document["btnRosas"].bind("click", lambda e: draw_rosas())


    </script>
</body>
</html>
